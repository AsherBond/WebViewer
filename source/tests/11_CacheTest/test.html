<!--
      CACHE TEST (Work in Progress, may fail)
      created by Martin Christen, martin.christen@fhnw.ch
      April 2011
-->
<!DOCTYPE html>
<html lang="en">
   <head>
         <script type="text/javascript" src="http://benvanik.github.com/WebGL-Inspector/core/embed.js"></script>
         <script type="text/javascript" src="../../core/openwebglobe.js"></script>
         <script type="text/javascript" src="../../core/shaders.js"></script>
         <script type="text/javascript" src="../../core/vec4.js"></script>
         <script type="text/javascript" src="../../core/mat4.js"></script>
         <script type="text/javascript" src="../../core/vec3.js"></script>
         <script type="text/javascript" src="../../core/mesh.js"></script>
         <script type="text/javascript" src="../../core/texture.js"></script>
         <script type="text/javascript" src="../../core/traversalstate.js"></script>
         <script type="text/javascript" src="../../core/eventhandler.js"></script>
         <script type="text/javascript" src="../../core/scenegraph.js"></script>
         <script type="text/javascript" src="../../core/node.js"></script>
         <script type="text/javascript" src="../../core/nodes/beginrender.js"></script>
         <script type="text/javascript" src="../../core/nodes/camera.js"></script>
         <script type="text/javascript" src="../../core/nodes/endrender.js"></script>
         <script type="text/javascript" src="../../core/nodes/logos.js"></script>
         <script type="text/javascript" src="../../core/nodes/navigation.js"></script>
         <script type="text/javascript" src="../../core/nodes/render.js"></script>
         <script type="text/javascript" src="../../core/nodes/renderobject.js"></script>
         <script type="text/javascript" src="../../core/font.js"></script>
         <script type="text/javascript" src="../../core/mathutils.js"></script>
         <script type="text/javascript" src="../../core/geocoord.js"></script>
         <script type="text/javascript" src="../../core/globeutils.js"></script>
         <script type="text/javascript" src="../../core/mercatorquadtree.js"></script>
         <script type="text/javascript" src="../../core/datasetinfo.js"></script>
         <script type="text/javascript" src="../../core/terrainblock.js"></script>
         <script type="text/javascript" src="../../core/globerenderer.js"></script>
         <script type="text/javascript" src="../../core/cache.js"></script>
         <script type="text/javascript" src="../../core/globecache.js"></script>
         <script type="text/javascript" src="../../core/layer/imagelayer.js"></script>
         <script type="text/javascript" src="../../core/layer/imagelayer_i3d.js"></script>
         <script type="text/javascript" src="../../core/layer/imagelayer_osm.js"></script>
         <script type="text/javascript">
         
         //---------------------------------------------------------------------
         // This demo shows how to use the image tile system together with 
         // the cache.
         // You should never do this manually!
         //---------------------------------------------------------------------
         
         var engine = null;
         var imgLayer = new i3dImageLayer();
         var bLayersAreReady = false;
         var globecache;
         
         //---------------------------------------------------------------------
         // Callback function for tile service
         function OnImageTileReady(quadcode, ImageObject)
         {
            console.log("Image Tile " + quadcode + " is now available!");
         }
         //---------------------------------------------------------------------
         // Callback function for tile service
         function OnImageTileFailed(quadcode)
         {
            console.log("Uh Oh!! Retrieving Image Tile " + quadcode + " failed!");
         }
        
         //---------------------------------------------------------------------
         function OnTimer(delta)
         {
            
         }
         
         //---------------------------------------------------------------------
         
         function OnResize(w,h)
         {
            width = w;
            height = h;       
         }
         
         //---------------------------------------------------------------------
         function OnKey(key)
         {
         }
         
         //---------------------------------------------------------------------
         
         function OnRender()
         {  
            var fontcolor = new vec4();
            fontcolor.Set(1,1,1,1);
            engine.DrawText("This is Image Layer Test", 0, height-32,1,fontcolor);
           
           
            // Test if globe cache is ready. if so we can make tile requests!! 
            if (globecache.IsReady())
            {
               if (!bLayersAreReady)
               {
                  console.log("All Layers are ready!");
               }
               bLayersAreReady = true;
            
               // make some requests 
           
               var tb0 = globecache.RequestBlock("0");
               var tb1 = globecache.RequestBlock("1");
               var tb2 = globecache.RequestBlock("2");
               var tb3 = globecache.RequestBlock("3");
               
               if (tb0.IsAvailable())
               {
                  // do something with available block
               }
          
            }
           
           /*for (var i=0;i<imgObjects.length;i++)
           {
              imgObjects[i].Blit(i*256,0);
           }*/
           
         }
         
         //---------------------------------------------------------------------
         
         function OnInit()
         { 
            // Setup an imagelayer:
            imgLayer.Setup("http://www.openwebglobe.org/data/img", "World500");
            
            // Create Array of image layers: (currently only one...)
            var imgLayerList = new Array();
            imgLayerList.push(imgLayer);
                  
            // Create Quadtree
            var quadtree = new MercatorQuadtree();
                  
            // Create Cache with specified size
            var cachesize = 100;
            globecache = new GlobeCache(engine, imgLayerList, null, quadtree, cachesize);
            
         }
        
         //---------------------------------------------------------------------
        
         function main()
         {
            engine = new engine3d();
           
            // Set Callbacks:
            engine.SetInitCallback(OnInit);
            engine.SetTimerCallback(OnTimer);
            engine.SetRenderCallback(OnRender);
            engine.SetResizeCallback(OnResize);
            engine.SetKeyDownCallback(OnKey)
            
            // Start engine...
            engine.InitEngine("canvas", true);  // (canvasid, fullscreen)
            engine.CreateScene();               // Create Globe Scene
            engine.SetClearColor(0.5,0.5,1,1);
         }
         
         //---------------------------------------------------------------------
         
      </script>
    </head>
    <body onload="main()">
        <div style="text-align: center">
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>
    </body>
</html>
