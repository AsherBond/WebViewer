<!--
      This is a minimal application using the cwc WebGL Engine
      Tutorial 2: Using internal shaders to simplify the application
-->
<!DOCTYPE html>
<html lang="en">
   <head>
      <script type="text/javascript" src="http://benvanik.github.com/WebGL-Inspector/core/embed.js"></script>
      <script type="text/javascript" src="../../core/openwebglobe.js"></script>
      <script type="text/javascript" src="../../core/shaders.js"></script>
      <script type="text/javascript" src="../../core/vec4.js"></script>
      <script type="text/javascript" src="../../core/mat4.js"></script>
      <script type="text/javascript" src="../../core/vec3.js"></script>
      <script type="text/javascript" src="../../core/mesh.js"></script>
      <script type="text/javascript" src="../../core/material.js"></script>
      <script type="text/javascript">
         
         //---------------------------------------------------------------------
         
         var totaltime = 0;
         var engine = null;
         var cube = null;
         var cube2 = null;
         var width = 0;
         var height = 0;
         var mvp1 =  new mat4();
         var mvp2 =  new mat4();
         
         
         //---------------------------------------------------------------------
         rot = 0;
         function OnTimer(delta)
         {
            rot= rot + delta / 550.0;
            
            totaltime = totaltime + delta;
            
            if (totaltime > 50)
            {
               /*var r=Math.abs(Math.random());
               var g=Math.abs(Math.random());
               var b=Math.abs(Math.random());
               engine.SetClearColor(r,g,b,1);*/
               totaltime = 0;
               
            }
         }
         
         //---------------------------------------------------------------------
         
         function OnResize(w,h)
         {
            width = w;
            height = h;
            console.log("Resize: " + w + ", " + h);
            
            // update projection matrix:
           
         }
         
         //---------------------------------------------------------------------
         
         var zpos = 10;
         var xpos = 0;
        
         function OnKey(key)
         {
            if (key == 87) // 'W'
            {
               zpos = zpos - 0.1;
            }
            else if (key == 83) //'S'
            {
               zpos = zpos + 0.1;
            }
            else if (key == 65) //'A'
            {
               xpos = xpos - 0.1;
            }
            else if (key ==  68) // 'D'
            {
               xpos = xpos + 0.1;
            }
         }
         
         //---------------------------------------------------------------------
         modelx=0;
         
         function CreateMVP(x,y,z, mvp)
         {
            
            var matModel = new mat4();
            var matView = new mat4();
            var matModelView = new mat4();
            var matProjection = new mat4(); 
            
            matModel.Translation(x,y,z);
         
            var aspect = width / height;
            matProjection.Perspective(45, aspect, 0.1, 500);
            //matProjection.Frustum(-1, 1, -1, 1, 2, 10);
            
            //matModel.RotationZ(rot);
            matView.LookAt(xpos,0,zpos, 0,0,0, 0,1,0);
            //rotMat=new mat4();
            //rotMat.RotationY(xpos);

            matModelView.Multiply(matView, matModel);
            mvp.Multiply(matProjection, matModelView);
            
            
         }
         
         function OnRender()
         {
            engine.SetClearColor(0.5,0.5,0.5,1);
            
           CreateMVP(0,0,0, mvp1);
           console.log(mvp1.ToString());
            
              
            tex.EnableTexture();
                                    
            if(cube)            
            {   
               if(cube.Ready)
               {   
                  cube.SetModelViewProjection(mvp1); 
                  cube.Draw();
               }       
            }
            tex.DisableTexture();
            
            
            CreateMVP(5,0,0, mvp2);
            console.log(mvp2.ToString());
            
              
         
            if(cube2)
            {  
               if(cube2.Ready)
               {
                  cube2.SetModelViewProjection(mvp2);                     
                  cube2.Draw();  
               }                
            }          
         }
         
         //---------------------------------------------------------------------
         
         function OnInit()
         {
              //--------------------------------------------------
              // CUBE
              //--------------------------------------------------
              /*
               var vertices = [
                   // position XYZ, color RGBA => 7 floats per vertex
                   -0.5,   0.5,  -0.5,  1.0,  0.0,  0.0,  1.0,
                    0.5,   0.5,  -0.5,  0.0,  1.0,  0.0,  1.0,
                   -0.5,  -0.5,  -0.5,  0.0,  0.0,  1.0,  1.0,
                    0.5,  -0.5,  -0.5,  1.0,  1.0,  0.0,  1.0,
                    0.5,  -0.5,   0.5,  1.0,  0.0,  1.0,  1.0,
                    0.5,   0.5,   0.5,  0.0,  0.0,  1.0,  1.0,
                   -0.5,   0.5,   0.5,  1.0,  1.0,  1.0,  1.0,
                   -0.5,  -0.5,   0.5,  0.0,  0.0,  0.0,  1.0,
               ];
               
               var indices = [ 0, 1, 2, 1, 2, 3, 1, 3, 4, 1, 5, 4, 0, 1, 6, 1, 5, 6, 5, 6, 7, 4, 5, 7, 0, 6, 7, 0, 2, 7, 2, 3, 7, 3, 4, 7];
               */
               tex = new material(engine);
               tex.loadTexture("Earth.gif");         

               cube = new Mesh(engine);
               cube.SetJSONLoadCallback(cbfCubeLoaded);
               cube.loadFromJSON("../../tests/00_JSONDemoFiles/cubePT.json");
               
                
               cube2 = new Mesh(engine);
               cube2.SetJSONLoadCallback(cbfCubeLoaded);
               cube2.loadFromJSON("../../tests/00_JSONDemoFiles/cubePC.json");
               
        
         }
         
         function cbfCubeLoaded(loadedmesh)
         {          
               loadedmesh.ToGPU();    
         }
         

         function init()
         {
         	engine = new engine3d();
           
            // Set Callbacks:
            engine.SetInitCallback(OnInit);
            engine.SetTimerCallback(OnTimer);
            engine.SetRenderCallback(OnRender);
            engine.SetResizeCallback(OnResize);
            engine.SetKeyDownCallback(OnKey)
            
            // Start engine...
            engine.InitEngine("canvas", true);  // (canvasid, fullscreen)
       
         }
         
         //---------------------------------------------------------------------
         
      </script>
    </head>
    <body onload="init()">
        <div style="text-align: center">
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>
    </body>
</html>
